* [锁的使用](#锁的使用)
* [一致性](#一致性)
  * [节点数要求](#节点数要求)
  * [一致性算法：Paxos](#一致性算法paxos)
* [锁的实现](#锁的实现)

* [故障恢复](#故障恢复)
  * [客户端租约到期怎么办？](#客户端租约到期怎么办)
  * [服务端租约到期怎么办？](#服务端租约到期怎么办)
* [通信](#通信)
  * [节点之间的通信](#节点之间的通信)
  * [服务器和客户端怎么通信](#服务器和客户端怎么通信)
* [应用场景](#应用场景)
  * [集群选主](#集群选主)
  * [进程监控](#进程监控)

## chubby是什么
* Chubby是早年Google四大基础设施之一，提供粗粒度的分布式锁服务。
* Chubby的使用者不需要关注复杂的同步协议，而是通过已经封装好的客户端直接调用锁服务，通过分布式锁，满足各种分布式场景下的一致性需求。
* 本质上是一个分布式文件系统，存储大量小文件。
* 每个文件就代表一个锁，并且可以保存一些应用层面的小规模数据。


## 锁的使用
* Chubby提供了直观如Acquire， release这样的锁操作
* 所有Primary的竞争者，Open同一个Node，之后用得到的Handle调用Acquire来获取锁
* 只有一个成功获得锁，成为Primary，其他竞争者称为Replicas；
* Primary将自己的标识通过SetContent写入Node；
* Replicas调用GetContentsAndStat获得当前的Primary标识，并注册该Node的内容修改Event，以便发现锁的Release或Primary的改变；
* Primary调用GetSequencer从当前的Handle中获得sequencer，并将其传递给所有需要锁保护的操作的Server；
* Server通过CheckSequencer检查其sequencer的合法性，拒绝旧的Primary的请求。



## 锁的实现
* [advisory lock](#./advisoryLock.md)

## 通信

### 节点之间的通信

### 服务器和客户端怎么通信
![服务器和客户端怎么通信](../imgs/google-chubby.png?raw=true)


## 一致性

### 节点数要求
一般5，至少3，方便做选举（过半则通过）

### 一致性算法：Paxos
* 多个副本组成一个集群，副本通过一致性协议选出一个master，集群在一个确定的租约时间内维持合格master的领导地位
* master周期性得向所有副本刷新延长自己的租约时间
* 每个副本通过一致性协议维护一份数据的备份，只有master可以写
* master挂了或脱离集群，其他副本发起选主选出新的master



## 故障恢复
### 客户端租约到期怎么办？

### 服务端租约到期怎么办？


## 应用场景

### 集群选主

### 进程监控
# 字典
字典的主要用途：
```
1、数据库键空间，key space；
2、Hash类型键的底层实现之一。
```
链接：
```
https://redisbook.readthedocs.io/en/latest/internal-datastruct/dict.html
```


## key space
什么是key space
```
redis是一个键值对数据库，每一个数据库对应一个字典，这个字典就是key space。
```
set
```
设置一个字符串键到key space
```

get
```
从key space获取一个字符串键的value
```

flushdb
```
清空这个字典
```

dbsize
```
返回字典的大小
```

randomkey
```
随机返回一个key，多用于惰性删除吧这里...
```

## 用作 Hash 类型键的底层实现之一

hash键的底层实现：
```
1、字典
2、压缩列表
```


# 字典的实现

## dictEntry: 
```dtd
typedef struct dictEntry{
    void *key;
    union{
        void *val;
        uint64_t u64;
        int64_t s64;
    } v;
    
    // 指向下个哈希表节点，形成链表
    struct dictEntry *next;
} dictEntry;
```
## dictht:
```dtd
typedef struct dictht{
    // 哈希表数组
    dictEntry **table;
    
    // 哈希表大小
    unsigned long size;
    
    // 哈希表大小掩码，用于计算掩码值， = size -1 
    unsigned long sizemask;
    
    // 哈希表已有节点的数量
    unsigned long used;
}dictht;
```

空的哈希表：
![redis 字典结构图.jpg](../../imgs/redis/redis字典结构图.jpg?raw=true)

有 2 个结点的哈希表：
![redis字典结构图3.jpg](../../imgs/redis/redis字典结构图3.jpg?raw=true)


## dict
```dtd
typedef struct dict{
    // 特定类型函数
    dictType *type;
    
    // 私有数据
    void *privData;

    // 2 个哈希表
    dictht ht[2] ;
    
    // rehash不进行时，-1
    int rehashidx;

}dict;
```
结构如下
![redis字典结构2.png](../../imgs/redis/redis字典结构2.png?raw=true)

其中的 dictType 和 privdata竟然是为了多态，C 语言的多态这么简单粗暴的吗？
```dtd
typedef struct dictType{
    // 计算 hash 值的函数
    unsigned int (*hashFunction)(const void *key);
    
    // 复制 key 的函数
    void *(*keyDup)(void *privdata, const void *key )
    // 复制 value 的函数
    // 对比 key 的函数
    // 销毁 key 的函数
    // 销毁 value 的函数
} dictType;
```